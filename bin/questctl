#!/usr/bin/env ruby

require 'quest'
require 'gli'

module GLIWrapper
  include GLI::App
  extend self

  # Controllers for the quest service
  # Move to questctl

  program_desc 'Controller for quest tool services.'

  desc 'Start the quest service'
  command :start do |c|
    c.flag [:q, :task_dir, 'task_dir'], :desc => 'Specify the task directory.'
    c.action do |global_options, options, args|
      messenger = Quest::Messenger.new( {'task_dir' => options[:task_dir]} )
      api = Thread.new do
        Quest::API.set :messenger, messenger
        Quest::API.run!
      end
      watcher = Thread.new do
        Quest::QuestWatcher.new(messenger).run!
      end
      Signal.trap("INT") do
        puts "Exiting"
        Thread.kill watcher
        Thread.kill api
        exit 130
      end
      watcher.join
      api.join
    end
  end
  exit run(ARGV)
end
